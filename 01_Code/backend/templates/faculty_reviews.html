{% extends 'base.html' %}
{% block title %}Faculty Feedback Insights | ClarifAI{% endblock %}
{% block page_title %}Feedback Insights{% endblock %}
{% block content %}
<div class="grid-4" style="margin-bottom:14px;">
    <div class="card">
        <small style="color:var(--muted);">Total Approved</small>
        <h3 style="margin:6px 0 0;">{{ kpi.total }}</h3>
    </div>
    <div class="card">
        <small style="color:var(--muted);">Positive</small>
        <h3 style="margin:6px 0 0;">{{ kpi.positive }}</h3>
    </div>
    <div class="card">
        <small style="color:var(--muted);">Neutral</small>
        <h3 style="margin:6px 0 0;">{{ kpi.neutral }}</h3>
    </div>
    <div class="card">
        <small style="color:var(--muted);">Negative</small>
        <h3 style="margin:6px 0 0;">{{ kpi.negative }}</h3>
    </div>
</div>

<div class="grid-3" style="margin-bottom:14px;">
    <div class="card chart-card">
        <h3 style="margin-top:0;">Sentiment Split</h3>
        <canvas id="facultySentimentPie"></canvas>
    </div>
    <div class="card chart-card">
        <h3 style="margin-top:0;">Top Feedback Reasons</h3>
        <canvas id="facultyReasonBar"></canvas>
    </div>
    <div class="card chart-card">
        <h3 style="margin-top:0;">Monthly Sentiment Trend</h3>
        <canvas id="facultyTrendLine"></canvas>
    </div>
</div>

<div class="card" style="margin-bottom:14px;">
    <form method="get" class="grid-2" style="align-items:end;">
        <div>
            <label class="label">Search</label>
            <input type="text" name="q" value="{{ search }}" placeholder="Subject / semester / reason / text">
        </div>
        <div>
            <label class="label">Sentiment</label>
            <select name="sentiment">
                <option value="all" {{ 'selected' if sentiment == 'all' else '' }}>All</option>
                <option value="positive" {{ 'selected' if sentiment == 'positive' else '' }}>Positive</option>
                <option value="neutral" {{ 'selected' if sentiment == 'neutral' else '' }}>Neutral</option>
                <option value="negative" {{ 'selected' if sentiment == 'negative' else '' }}>Negative</option>
            </select>
        </div>
        <div class="flex" style="grid-column:1 / -1; margin-top:6px;">
            <button class="btn primary" type="submit">Apply</button>
            <a class="btn" href="{{ url_for('faculty.reviews') }}">Reset</a>
        </div>
    </form>
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Semester</th>
                <th>Reason</th>
                <th>Feedback</th>
                <th>Sentiment</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
        {% for item in reviews %}
            <tr>
                <td>{{ item.subject }}</td>
                <td>{{ item.semester }}</td>
                <td>{{ item.reason }}</td>
                <td>{{ item.feedback_text }}</td>
                <td>{{ item.sentiment|title }}</td>
                <td>{{ item.created_at.strftime('%d %b %Y %I:%M %p') }}</td>
            </tr>
        {% else %}
            <tr><td colspan="6">No approved feedback found.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
    const payload = {{ chart_payload | tojson }};
    const css = getComputedStyle(document.documentElement);
    const textColor = css.getPropertyValue('--text').trim();
    const gridColor = css.getPropertyValue('--border').trim();

    new Chart(document.getElementById('facultySentimentPie'), {
        type: 'pie',
        data: {
            labels: payload.sentiment_labels,
            datasets: [{
                data: payload.sentiment_values,
                backgroundColor: ['#34d399', '#fbbf24', '#fb7185']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: textColor } } }
        }
    });

    new Chart(document.getElementById('facultyReasonBar'), {
        type: 'bar',
        data: {
            labels: payload.reason_labels,
            datasets: [{
                label: 'Count',
                data: payload.reason_values,
                backgroundColor: '#6366f1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { labels: { color: textColor } } },
            scales: {
                x: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true },
                y: { ticks: { color: textColor }, grid: { color: gridColor } }
            }
        }
    });

    new Chart(document.getElementById('facultyTrendLine'), {
        type: 'line',
        data: {
            labels: payload.trend_labels,
            datasets: [
                {
                    label: 'Positive',
                    data: payload.trend_positive,
                    borderColor: '#34d399',
                    backgroundColor: 'rgba(52, 211, 153, 0.16)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Negative',
                    data: payload.trend_negative,
                    borderColor: '#fb7185',
                    backgroundColor: 'rgba(251, 113, 133, 0.16)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: textColor } } },
            scales: {
                x: { ticks: { color: textColor }, grid: { color: gridColor } },
                y: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true }
            }
        }
    });
})();
</script>
{% endblock %}
