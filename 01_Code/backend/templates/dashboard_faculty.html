{% extends 'base.html' %}
{% block title %}Faculty Dashboard | ClarifAI{% endblock %}
{% block page_title %}Faculty Dashboard{% endblock %}
{% block content %}
<div class="grid-3" style="margin-bottom:14px;">
    <div class="card">
        <small style="color:var(--muted);">Total Checklists</small>
        <h3 style="margin:6px 0 0;">{{ checklists|length }}</h3>
    </div>
    <div class="card">
        <small style="color:var(--muted);">Completed</small>
        <h3 style="margin:6px 0 0;">{{ completed_count }}</h3>
    </div>
    <div class="card">
        <small style="color:var(--muted);">Pending</small>
        <h3 style="margin:6px 0 0;">{{ pending_count }}</h3>
    </div>
    <div class="card">
        <small style="color:var(--muted);">Resources Shared</small>
        <h3 style="margin:6px 0 0;">{{ total_resources }}</h3>
    </div>
</div>

<div class="card chart-card" style="margin-bottom:14px;">
    <h3 style="margin-top:0;">Execution Overview</h3>
    <canvas id="facultyExecutionChart"></canvas>
</div>

<div class="flex" style="margin-bottom:12px;">
    <a class="btn" href="{{ url_for('faculty.reviews') }}">Feedback Insights</a>
    <a class="btn" href="{{ url_for('faculty.checklists_page') }}">Manage Checklists</a>
    <a class="btn" href="{{ url_for('faculty.my_resources') }}">My Resources</a>
    <a class="btn primary" href="{{ url_for('faculty.resource_post') }}">Share Resource</a>
</div>

<div class="grid-2">
    <div class="card">
        <h3 style="margin-top:0;">Create Checklist</h3>
        <form method="post" action="{{ url_for('faculty.create_checklist') }}">
            <label class="label">Title</label>
            <input type="text" name="title" required>

            <label class="label">Description</label>
            <textarea name="description"></textarea>

            <label class="label">Student Email</label>
            <input type="email" name="student_email" required>

            <div style="margin-top:14px;">
                <button class="btn primary" type="submit">Create</button>
            </div>
        </form>
    </div>

    <div class="card">
        <h3 style="margin-top:0;">Checklist Progress</h3>
        {% for item in checklists %}
            <div style="border-bottom:1px solid var(--border); padding:10px 0;">
                <strong>{{ item.title }}</strong>
                <div style="color:var(--muted);">{{ item.student.full_name }} ({{ item.student.email }})</div>
                <span class="badge {{ 'approved' if item.is_completed else 'under_review' }}">
                    {{ 'Completed' if item.is_completed else 'Pending' }}
                </span>
            </div>
        {% else %}
            <p>No checklist records yet.</p>
        {% endfor %}
    </div>
</div>

<div class="card" style="margin-top:14px;">
    <h3 style="margin-top:0;">Recent Resources</h3>
    {% for post in recent_resources %}
        <div style="border-bottom:1px solid var(--border); padding:10px 0;">
            <strong>{{ post.title }}</strong>
            <div style="color:var(--muted);">{{ post.created_at.strftime('%d %b %Y %I:%M %p') }}</div>
        </div>
    {% else %}
        <p>No resources shared yet.</p>
    {% endfor %}
</div>

<div class="card" style="margin-top:14px;">
    <h3 style="margin-top:0;">Approved Feedback (Identity Hidden)</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Feedback</th>
                <th>Sentiment</th>
                <th>Status</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
        {% for item in approved_feedback %}
            <tr>
                <td>{{ item.feedback_text }}</td>
                <td>{{ item.sentiment|title }}</td>
                <td><span class="badge approved">Approved</span></td>
                <td>{{ item.created_at.strftime('%d %b %Y %I:%M %p') }}</td>
            </tr>
        {% else %}
            <tr><td colspan="4">No approved feedback available.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
    const payload = {{ dashboard_chart | tojson }};
    const css = getComputedStyle(document.documentElement);
    const textColor = css.getPropertyValue('--text').trim();
    const gridColor = css.getPropertyValue('--border').trim();

    new Chart(document.getElementById('facultyExecutionChart'), {
        type: 'bar',
        data: {
            labels: payload.labels,
            datasets: [{
                label: 'Count',
                data: payload.values,
                backgroundColor: ['#34d399', '#fbbf24', '#6366f1']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: textColor } } },
            scales: {
                x: { ticks: { color: textColor }, grid: { color: gridColor } },
                y: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true }
            }
        }
    });
})();
</script>
{% endblock %}