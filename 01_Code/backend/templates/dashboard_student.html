{% extends 'base.html' %}
{% block title %}Student Dashboard | ClarifAI{% endblock %}
{% block page_title %}Student Dashboard{% endblock %}
{% block content %}
<div class="student-hero-card" style="margin-bottom:14px;">
    <div>
        <p class="student-hero-title">Hello, {{ student.full_name.split(' ')[0] }} ðŸ‘‹</p>
        <p class="student-hero-sub">{{ student.unique_user_code }} Â· MCA Student Workspace</p>
    </div>
    <div class="student-hero-actions">
        <a class="btn" href="{{ url_for('student.reviews') }}"><i data-lucide="message-square-text"></i> My Reviews</a>
        <button class="btn primary" data-open-modal="feedbackModal"><i data-lucide="plus-circle"></i> Submit Feedback</button>
    </div>
</div>

<div class="student-pulse-banner" style="margin-bottom:14px;">
    <div>
        <p class="student-pulse-main">Mid-Semester Feedback Window is Open</p>
        <p class="student-pulse-sub">Share high-quality constructive feedback to improve teaching outcomes.</p>
    </div>
    <button class="btn primary" data-open-modal="feedbackModal">Submit Now</button>
</div>

<div class="grid-4" style="margin-bottom:14px;">
    <div class="card modern-stat">
        <div class="modern-stat-head">
            <small>Total Submitted</small>
            <i data-lucide="message-square" class="modern-stat-icon"></i>
        </div>
        <h3>{{ total_feedback }}</h3>
        <p>This semester</p>
    </div>
    <div class="card modern-stat">
        <div class="modern-stat-head">
            <small>Approved</small>
            <i data-lucide="check-circle-2" class="modern-stat-icon"></i>
        </div>
        <h3>{{ chart_payload.status_counts[0] }}</h3>
        <p>Visible to faculty</p>
    </div>
    <div class="card modern-stat">
        <div class="modern-stat-head">
            <small>Under Review</small>
            <i data-lucide="clock-3" class="modern-stat-icon"></i>
        </div>
        <h3>{{ chart_payload.status_counts[1] }}</h3>
        <p>Awaiting moderation</p>
    </div>
    <div class="card modern-stat">
        <div class="modern-stat-head">
            <small>Checklist Progress</small>
            <i data-lucide="list-checks" class="modern-stat-icon"></i>
        </div>
        <h3>{{ progress_percent }}%</h3>
        <div class="progress"><span style="width:{{ progress_percent }}%"></span></div>
    </div>
</div>

<div class="grid-3" style="margin-bottom:14px;">
    <div class="card chart-card">
        <h3 style="margin-top:0;">Department Sentiment Trend</h3>
        <p class="chart-subtitle">Your submissions over recent months</p>
        <canvas id="studentTrendChart"></canvas>
    </div>
    <div class="card chart-card">
        <h3 style="margin-top:0;">Sentiment Distribution</h3>
        <p class="chart-subtitle">Positive vs neutral vs negative</p>
        <canvas id="studentSentimentChart"></canvas>
    </div>
    <div class="card chart-card">
        <h3 style="margin-top:0;">Moderation Status</h3>
        <p class="chart-subtitle">Approval pipeline visibility</p>
        <canvas id="studentStatusChart"></canvas>
    </div>
</div>

<div class="grid-2">
    <div class="card">
        <div class="space-between" style="margin-bottom:12px;">
            <h3 style="margin:0;">Recent Submissions</h3>
            <a class="btn" href="{{ url_for('student.reviews') }}">View All</a>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Faculty</th>
                    <th>Sentiment</th>
                    <th>Status</th>
                    <th>Submitted On</th>
                </tr>
            </thead>
            <tbody>
            {% for item in feedback_items %}
                <tr>
                    <td>{{ item.faculty.full_name }}</td>
                    <td>{{ item.sentiment|title }}</td>
                    <td><span class="badge {{ item.status }}">{{ item.status.replace('_', ' ')|title }}</span></td>
                    <td>{{ item.created_at.strftime('%d %b %Y %I:%M %p') }}</td>
                </tr>
            {% else %}
                <tr><td colspan="4">No submissions yet.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="space-between" style="margin-bottom:12px;">
            <h3 style="margin:0;">My Checklist</h3>
            <a class="btn" href="{{ url_for('student.my_checklists') }}">View All</a>
        </div>
        {% for item in checklists[:5] %}
            <form method="post" action="{{ url_for('student.toggle_checklist', checklist_id=item.id) }}" class="space-between" style="margin-bottom:9px;">
                <div>
                    <strong>{{ item.title }}</strong>
                    <div style="color:var(--muted);">Assigned by {{ item.faculty.full_name }}</div>
                </div>
                <button class="btn {{ 'success' if item.is_completed else '' }}" type="submit">
                    {{ 'Completed' if item.is_completed else 'Mark Done' }}
                </button>
            </form>
        {% else %}
            <p>No checklist items assigned.</p>
        {% endfor %}
    </div>
</div>

<div class="card" style="margin-top:14px;">
    <div class="space-between" style="margin-bottom:12px;">
        <h3 style="margin:0;">Experience & Resource Board</h3>
        <a class="btn" href="{{ url_for('student.knowledge_board') }}">View All</a>
    </div>
    <div class="grid-2">
        {% for post in posts[:6] %}
            <div style="border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--surface-strong);">
                <div class="space-between" style="align-items:flex-start; gap:8px;">
                    <strong>{{ post.title }}</strong>
                    <span class="badge {{ 'approved' if post.author.role == 'faculty' else 'under_review' }}">{{ 'Resource' if post.author.role == 'faculty' else 'Experience' }}</span>
                </div>
                <div style="color:var(--muted); margin-top:6px;">{{ post.author.full_name }} â€¢ {{ post.created_at.strftime('%d %b %Y') }}</div>
            </div>
        {% else %}
            <p>No posts yet.</p>
        {% endfor %}
    </div>
</div>

<div class="modal" id="feedbackModal">
    <div class="modal-card">
        <div class="space-between">
            <h3 style="margin-top:0;">Submit Feedback</h3>
            <button class="btn" type="button" data-close-modal>Close</button>
        </div>
        <form method="post" action="{{ url_for('student.submit_feedback') }}">
            <label class="label">Faculty</label>
            <select name="faculty_id" required>
                <option value="">Select faculty</option>
                {% for faculty in faculty_list %}
                    <option value="{{ faculty.id }}">{{ faculty.full_name }} ({{ faculty.faculty_id }})</option>
                {% endfor %}
            </select>

            <label class="label">Subject / Course</label>
            <input type="text" name="subject" placeholder="e.g. Data Structures" required>

            <label class="label">Semester</label>
            <input type="text" name="semester" placeholder="e.g. Semester 2" required>

            <label class="label">Reason</label>
            <input type="text" name="reason" placeholder="e.g. Teaching quality" required>

            <label class="label">Feedback</label>
            <textarea name="feedback_text" required></textarea>

            <div class="flex" style="margin-top:14px;">
                <button class="btn primary" type="submit">Submit</button>
                <button class="btn" type="button" data-close-modal>Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
    const payload = {{ chart_payload | tojson }};
    const css = getComputedStyle(document.documentElement);
    const textColor = css.getPropertyValue('--text').trim();
    const gridColor = css.getPropertyValue('--border').trim();

    const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: textColor } } },
        scales: {
            x: { ticks: { color: textColor }, grid: { color: gridColor } },
            y: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true }
        }
    };

    new Chart(document.getElementById('studentTrendChart'), {
        type: 'line',
        data: {
            labels: payload.monthly_labels,
            datasets: [{
                label: 'Reviews',
                data: payload.monthly_counts,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.18)',
                fill: true,
                tension: 0.35
            }]
        },
        options: baseOptions
    });

    new Chart(document.getElementById('studentSentimentChart'), {
        type: 'pie',
        data: {
            labels: payload.sentiment_labels,
            datasets: [{
                data: payload.sentiment_counts,
                backgroundColor: ['#34d399', '#fbbf24', '#fb7185']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: textColor } } }
        }
    });

    new Chart(document.getElementById('studentStatusChart'), {
        type: 'bar',
        data: {
            labels: payload.status_labels,
            datasets: [{
                label: 'Count',
                data: payload.status_counts,
                backgroundColor: ['#34d399', '#fbbf24', '#f97316', '#fb7185']
            }]
        },
        options: baseOptions
    });
})();
</script>
{% endblock %}